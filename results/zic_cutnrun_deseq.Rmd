---
title: "zic_cutnrun_deseq"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Differential binding analysis of Zic CUT&RUN data

Steps:
- Get union of peaks across replicates / timepoints
- Get counts matrix
- Test

# Get union of peaks

## load cutnrun peaks as granges objects
```{r}
library(rtracklayer)
library(tidyverse)

cutnrun_peaks_dir <- "../data_output/cutnrun_zic/seacr_peaks/"
cutnrun_peaks_files <- list.files(cutnrun_peaks_dir,pattern = ".bed")
cutnrun_peaks_full <- paste0(cutnrun_peaks_dir,cutnrun_peaks_files)


cutnrun_peaks_granges <- lapply(cutnrun_peaks_full, import.bedGraph)

names(cutnrun_peaks_granges) <- str_split(cutnrun_peaks_files,"_",n=2) %>% map_chr(1)

names(cutnrun_peaks_granges) <- paste0("cutnrun-",names(cutnrun_peaks_granges))

```

## get union

```{r}
cutnrun_peaks_union_granges <- GenomicRanges::union(unlist(GRangesList(cutnrun_peaks_granges)),
                                                    unlist(GRangesList(cutnrun_peaks_granges)))



```

## remove peaks that overlap blacklist

```{r}
mm10_blacklist <- import("../data_input/bed/mm10-blacklist.v2.bed.gz")
cutnrun_peaks_union_granges <- cutnrun_peaks_union_granges[!overlapsAny(cutnrun_peaks_union_granges, mm10_blacklist)]

```



```{r}
elementMetadata(distanceToNearest(cutnrun_peaks_union_granges))$distance %>%
  summary()

```

```{r}
summary(width(cutnrun_peaks_union_granges))
```

```{r}
sum(width(cutnrun_peaks_union_granges) > 10000)
```

```{r eval = FALSE}
export.bed(cutnrun_peaks_union_granges,"../data_output/bed/cutnrun_zic_seacr_peaks_union.bed")
```


# Get counts matrix
```{r}
library(csaw)
bam_files <- list.files("../data_output/cutnrun_zic/bam/",pattern = ".bam$",full.names = T)
counts <- csaw::regionCounts(bam.files = bam_files,
                   regions = cutnrun_peaks_union_granges,
                   param = csaw::readParam(dedup = TRUE, minq = 20))

colnames(counts) <- str_split(basename(bam_files),"_",2) %>% map_chr(1)

colData(counts)$rep <- str_split(colnames(counts),"-") %>% map_chr(1)
colData(counts)$time <- str_split(colnames(counts),"-") %>% map_chr(2)

```

## Get DESeq object

```{r}
library(DESeq2)

deseq_obj <- DESeqDataSet(counts, design = ~ time)


```

Prefiltering
```{r}
keep <- rowSums(counts(deseq_obj)) >= 10
deseq_obj <- deseq_obj[keep,]

```


# Test
LRT test that is conceptually similar to ANOVA
```{r}
deseq_obj <- DESeq(deseq_obj, test="LRT", reduced=~1)
res <- results(deseq_obj)

```

```{r}
res %>%
  as_tibble() %>%
  ggplot(aes(padj)) +
  geom_histogram()
```

```{r}
res %>%
  as_tibble() %>%
  ggplot(aes(log2FoldChange, -10*log10(padj))) +
  geom_point()
```
```{r}
res %>%
  as_tibble() %>%
ggplot(aes(x = baseMean,log2FoldChange)) +
  geom_point()
```

# Plots

## Volcano / MA

## Heatmap

## Aleuvial 

